from multiprocessing import Process
from tkinter import *
from tkinter import ttk
import tkinter
import matplotlib
import matplotlib.pyplot as plt
import matplotlib.animation as anim
from matplotlib.backends.backend_tkagg import (FigureCanvasTkAgg, 
NavigationToolbar2Tk)
import numpy as np
import pandas as pd

class displayGraph:

    def __init__(self, root, mainframe): 
        
        # initiate variables
        self.mainframe = mainframe
        self.root = root
        self.root.title("Displays Graph")

        #Variables
        self.totalFrames = 60
        self.fps = round(1000/self.totalFrames)
        self.text = StringVar(self.mainframe, value="Graph Generator")
        self.launchButtonText = StringVar(self.mainframe, value="Generate")
        self.animationButtonText = StringVar(self.mainframe, value="Start Animation")
        self.onOff = BooleanVar(self.mainframe, value=False)
        self.frequency = 1.0
        self.params = ((10,10),(4,12),(50,12),(6,55))
        self.offset = 0
        self.offsetArray = np.linspace(0, 1, self.totalFrames+1)
        self.animation_running = False
        self.frame = 1
 
        #Title Label
        label = ttk.Label(self.mainframe, textvariable=self.text, font=("Arial", 16))
        label.grid(column=45, row = 15)

        # buttons
        # launch button
        lb = ttk.Button(self.mainframe, width=20, textvariable=self.launchButtonText, command=self.closeOrLaunch)
        lb.grid(column=45, row = 30)

        self.ab = ttk.Button(self.mainframe, width=20, textvariable=self.animationButtonText, command=self.startOrStopAnimation)
        self.ab.grid(column=45, row = 60)
        self.ab.config(state='disabled')

        #slider
        slider = tkinter.Scale(mainframe, from_=1, to=15, orient=tkinter.VERTICAL,
                              command=self.update_frequency, label="Frequency [Hz]")
        slider.grid(column=1, row=45, sticky=(N,S), columnspan=20)

    def closeOrLaunch(self):
        if self.onOff.get():
            self.close()
            self.onOff.set(False)
        else:
            self.launch()
            self.onOff.set(True)
    
    def close(self):
        self.animation_running = False
        self.animationButtonText.set("Start Animation"),
        self.text.set("Graph Closed")
        self.launchButtonText.set("Generate")
        self.ab.config(state='disabled')
        self.canvas.get_tk_widget().destroy()

    def launch(self):
        self.ab.config(state='enabled')
        self.text.set("Graph Launched")
        self.launchButtonText.set("Close")

        #initialize figure and axis
        self.fig = plt.figure(figsize=(5,4), dpi=100, layout='constrained')
        self.ax = self.fig.add_subplot()     
        self.canvas = FigureCanvasTkAgg(self.fig, master=self.mainframe)
        self.canvas.get_tk_widget().grid(column=45, row=45, sticky=(E,W))
        
        self.draw()     

    def draw(self):
        self.ax.clear()
        for a, b in self.params:
            multiplier = self.frequency
            getValues = np.random.beta(a * multiplier, b * multiplier, 1000) + self.offset
            values = [x-1 if x > 1 else x for x in getValues]
            self.ax.hist(values, bins=100, alpha=0.8, density=True, histtype='stepfilled')
            self.ax.set_xlim(0, 1),
            self.ax.set_ylim(0, 20)
        self.canvas.draw_idle() 

    def update_frequency(self, new_val):
        self.frequency = float(new_val)
        if self.animation_running:
            pass
        else:
            self.draw()

    # animation functions
    def startOrStopAnimation(self):
        if self.animation_running:
            self.animation_running = False
            self.animationButtonText.set("Start Animation")
        else:
            self.animation_running = True
            self.start_animation()
            self.animationButtonText.set("Stop Animation")
            
    def start_animation(self):
        self.animation_running = True
        self.animate_frame(self.frame)

    def animate_frame(self, frame):
        self.frame = frame
        if frame < self.totalFrames and self.animation_running:
            self.update(frame)
            self.mainframe.after(self.fps, self.animate_frame, frame + 1)
        elif frame == self.totalFrames and self.animation_running:
            self.update(frame)
            self.mainframe.after(self.fps, self.animate_frame, frame = 1)
        else: 
            pass
        
    def update(self, frame):
        self.ax.clear()
        self.offset = self.offsetArray[frame]
        self.draw()

def run_gui():
    root = Tk()
    mainframe = ttk.Frame(root, padding=(10, 10))
    mainframe.grid(column=0, row=0, sticky=(N, W, E, S))
    displayGraph(root, mainframe)
    def on_closing():
        root.quit()
        root.destroy()
    root.protocol("WM_DELETE_WINDOW", on_closing)
    root.mainloop()

if __name__ == "__main__":
    # Start GUI in a separate process. Don't daemonize so it runs independently.
    p = Process(target=run_gui)
    p.start()
    
    while p.is_alive():
        pass
    else:
        p.terminate()
        p.join()