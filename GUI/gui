from multiprocessing import Process
from tkinter import *
from tkinter import ttk
import tkinter
import matplotlib
import matplotlib.pyplot as plt
from matplotlib.backends.backend_tkagg import (FigureCanvasTkAgg, 
NavigationToolbar2Tk)
import numpy as np
import pandas as pd

class displayGraph:

    def __init__(self, root, mainframe): 
        
        # initiate variables
        self.mainframe = mainframe
        self.root = root
        self.root.title("Displays Graph")

        #Variables
        self.text = StringVar(self.mainframe, value="Graph Generator")
        self.buttonText = StringVar(self.mainframe, value="Generate")
        self.onOff = BooleanVar(self.mainframe, value=False)
        self.frequency = 1.0
        self.params = ((10,10),(4,12),(50,12),(6,55))

        #Title Label
        label = ttk.Label(self.mainframe, textvariable=self.text, font=("Arial", 16))
        label.grid(column=45, row = 15)

        # buttons
        # launch button
        lb = ttk.Button(self.mainframe, width=20, textvariable=self.buttonText, command=self.closeOrLaunch)
        lb.grid(column=45, row = 30)

        #slider
        slider = tkinter.Scale(mainframe, from_=1, to=5, orient=tkinter.HORIZONTAL,
                              command=self.update_frequency, label="Frequency [Hz]")
        slider.grid(column=45, row=60)

    def closeOrLaunch(self):
        if self.onOff.get():
            self.close()
            self.onOff.set(False)
        else:
            self.launch()
            self.onOff.set(True)
    
    def close(self):
        self.text.set("Graph Closed")
        self.buttonText.set("Generate")
        plt.close(self.fig)
        self.canvas.get_tk_widget().destroy()

    def launch(self):
        self.text.set("Graph Launched")
        self.buttonText.set("Close")
        self.fig = plt.figure(figsize=(5,4), dpi=100, layout='constrained')
        ax = self.fig.add_subplot()

        # generate data for hist
        for a, b in self.params:
            multiplier = self.frequency
            values = np.random.beta(a*multiplier, b*multiplier, 1000)
            ax.hist(values, bins=30, alpha=0.8, density=True, histtype='stepfilled')
        
        self.canvas = FigureCanvasTkAgg(self.fig, master=self.mainframe)
        self.canvas.draw()
        self.canvas.get_tk_widget().grid(column=45, row=45, sticky=(E,W))

    def update_frequency(self, new_val):
        self.frequency = float(new_val)
        plt.close(self.fig)
        self.canvas.get_tk_widget().destroy()
        self.launch()
    # def _quit(self):
    #     self.root.quit()
    #     self.root.destroy()


def run_gui():
    root = Tk()
    mainframe = ttk.Frame(root, padding=(10, 10))
    mainframe.grid(column=0, row=0, sticky=(N, W, E, S))
    displayGraph(root, mainframe)
    def on_closing():
        root.quit()
        root.destroy()
    root.protocol("WM_DELETE_WINDOW", on_closing)
    root.mainloop()

if __name__ == "__main__":
    # Start GUI in a separate process. Don't daemonize so it runs independently.
    p = Process(target=run_gui)
    p.start()
    
    while p.is_alive():
        pass
    else:
        p.terminate()
        p.join()